name: Build and Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        type: string
      message:
        description: 'Release message,use "|||" for line breaks'
        required: false
        type: string
        default: ''
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true

jobs:
  check:
    name: Check code error
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Upgrade pip and install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pyflakes

      - name: Check code with PowerShell
        id: check
        shell: pwsh
        run: |
          # ç”¨PowerShellçš„æ–¹å¼æ£€æŸ¥
          pyflakes . 2>&1 | Out-File -FilePath errors.txt
          
          $errors = Get-Content errors.txt -Raw
          
          if ($errors.Trim().Length -gt 0) {
              Write-Host "âŒ å‘ç°ä»£ç é”™è¯¯" -ForegroundColor Red
              Write-Host "should_build=false" >> $env:GITHUB_OUTPUT
              
              # æ¼‚äº®çš„HTMLè¾“å‡º
              $htmlError = $errors -replace "`n", "<br>`n" -replace "  ", "&nbsp;&nbsp;"
              @"
              <h1>ğŸ” ä»£ç æ£€æŸ¥å‘ç°é”™è¯¯ï¼</h1>
              <p>è¯·ä¿®å¤ä»¥ä¸‹é”™è¯¯åå†æ„å»ºï¼š</p>
              <div style="background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:5px;font-family:'Courier New',monospace;">
              <pre>$htmlError</pre>
              </div>
              "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
              
              exit 1
          } else {
              Write-Host "âœ… ä»£ç æ£€æŸ¥é€šè¿‡" -ForegroundColor Green
              Write-Host "should_build=true" >> $env:GITHUB_OUTPUT
              Remove-Item errors.txt -ErrorAction SilentlyContinue
          }

      - name: Upload artifact if errors exist
        uses: actions/upload-artifact@v4
        if: ${{ steps.check.outputs.should_build == 'false' }}
        with:
          name: errors
          path: errors.txt

  build:
    needs: check
    name: Build Executables
    runs-on: ${{ matrix.os }}
    if: ${{ needs.check.outputs.should_build == 'true' }}
    strategy:
      matrix:
        include:
          - name: 'winx64'
            os: 'windows-latest'
            arch: 'x64'
            icon_arg: '--icon icon.ico --add-data "icon.ico:."'
          - name: 'winx86'
            os: 'windows-latest'
            arch: 'x86'
            icon_arg: '--icon icon.ico --add-data "icon.ico:."'
          - name: 'linuxx64'
            os: 'ubuntu-latest'
            arch: 'x64'
            icon_arg: '--add-data "icon.ico:."'
          - name: 'linuxx86'
            os: 'ubuntu-latest'
            arch: 'x86'
            icon_arg: '--add-data "icon.ico:."'
          - name: 'macosintel'
            os: 'macos-latest'
            arch: 'x64'
            icon_arg: '--add-data "icon.ico:."'
          - name: 'macosm'
            os: 'macos-latest'
            arch: 'arm64'
            icon_arg: '--add-data "icon.ico:."'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
  
      - name: Upgrade pip and install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          
          # æ£€æŸ¥å¹¶å®‰è£…requirements.txt
          if (Test-Path "requirements.txt") {
              pip install -r requirements.txt
          } else {
              Write-Warning "requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          }
  
      - name: Build executable (é€šç”¨PowerShellç‰ˆæœ¬)
        shell: pwsh
        run: |
          Write-Host "=== å¼€å§‹æ„å»º ${{ matrix.name }} ===" -ForegroundColor Cyan
          
          $version = "${{ github.event.inputs.version }}"
          $name = "${{ matrix.name }}"
          
          # æ ¹æ®å¹³å°å†³å®šæ‰©å±•åå’Œå‚æ•°
          if ("${{ matrix.os }}" -like "*windows*") {
              $exeName = "EasySearch_${version}_${name}.exe"
              $windowedArg = "--windowed"
          } else {
              $exeName = "EasySearch_${version}_${name}"
              $windowedArg = ""
          }
          
          # æ„å»ºPyInstallerå‘½ä»¤
          $pyinstallerArgs = @(
              "--noconfirm",
              "--onefile",
              $windowedArg,
              "${{ matrix.icon_arg }}",
              "--name", $exeName,
              "main.py"
          )
          
          # æ‰§è¡Œæ„å»º
          Write-Host "æ‰§è¡Œ: pyinstaller $pyinstallerArgs"
          pyinstaller $pyinstallerArgs
          
          Write-Host "=== æ„å»ºå®Œæˆ: $exeName ===" -ForegroundColor Green
  
      - name: Generate SHA256 checksum (ç»Ÿä¸€PowerShellç‰ˆæœ¬)
        shell: pwsh
        run: |
          Write-Host "=== ç”Ÿæˆ ${{ matrix.name }} çš„ SHA256 æ ¡éªŒç  ===" -ForegroundColor Yellow
          
          $version = "${{ github.event.inputs.version }}"
          $name = "${{ matrix.name }}"
          
          if ("${{ matrix.os }}" -like "*windows*") {
              $fileName = "EasySearch_${version}_${name}.exe"
          } else {
              $fileName = "EasySearch_${version}_${name}"
          }
          
          $filePath = "dist/$fileName"
          
          # è®¡ç®—å“ˆå¸Œå€¼
          $hash = Get-FileHash -Path $filePath -Algorithm SHA256
          $checksum = $hash.Hash.ToLower()
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          "$name`:$checksum" | Out-File -FilePath "sha256_EasySearch_${version}_${name}.txt" -Encoding utf8
          
          Write-Host "æ ¡éªŒç : $checksum" -ForegroundColor Green
          Write-Host "=== ç”Ÿæˆå®Œæˆ ==="
  
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            dist/EasySearch_${{ github.event.inputs.version }}_${{ matrix.name }}*
            sha256_EasySearch_${{ github.event.inputs.version }}_${{ matrix.name }}.txt

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
  
      - name: Prepare Release Message with PowerShell
        id: prepare-message
        shell: pwsh
        run: |
          $inputMessage = "${{ github.event.inputs.message }}"
          
          if ([string]::IsNullOrWhiteSpace($inputMessage)) {
              $finalMessage = "Release ${{ github.event.inputs.version }}"
          } else {
              # æ›¿æ¢ ||| ä¸ºæ¢è¡Œ
              $finalMessage = $inputMessage -replace '\|\|\|', '<br>'
          }
          
          # è¾“å‡ºç»“æœ
          Write-Host "æœ€ç»ˆæ¶ˆæ¯: $finalMessage" -ForegroundColor Cyan
          Write-Output "final_message=$finalMessage" >> $env:GITHUB_OUTPUT
  
      - name: Collect artifact files for release
        id: collect-files
        shell: pwsh
        run: |
          # æ”¶é›†æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶å’Œæ ¡éªŒæ–‡ä»¶
          $files = @()
          
          Get-ChildItem -Path ./artifacts -Recurse -File | Where-Object {
              $_.Name -match '\.(exe|txt)$' -and $_.Name -notmatch 'errors'
          } | ForEach-Object {
              $files += $_.FullName
              Write-Host "ğŸ“¦ æ·»åŠ æ–‡ä»¶: $($_.Name)"
          }
          
          # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨å­—ç¬¦ä¸²
          $fileList = $files -join "`n"
          Write-Output "file_list=$fileList" >> $env:GITHUB_OUTPUT
          Write-Host "æ€»å…±æ‰¾åˆ° $($files.Count) ä¸ªæ–‡ä»¶"
  
      - name: Create Release Draft with Tag
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: ${{ steps.prepare-message.outputs.final_message }}
          draft: ${{ github.event.inputs.draft }}
          files: ${{ steps.collect-files.outputs.file_list }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
      - name: Add Release Link to Summary
        shell: pwsh
        run: |
          $isDraft = [System.Convert]::ToBoolean('${{ github.event.inputs.draft }}')
          $releaseUrl = '${{ steps.create-release.outputs.url }}'
          
          if ($isDraft) {
              @"
              <h1>ğŸ“ è‰ç¨¿Releaseå·²åˆ›å»º</h1>
              <p>è‰ç¨¿Releaseï¼š<a href='$releaseUrl'>ç‚¹æ­¤è·³è½¬</a></p>
              <p><strong>ä»“åº“åä½œè€…å¯è¿›è¡Œå®Œå–„ç„¶åå‘å¸ƒ</strong></p>
              <div style="background:#e3f2fd;padding:15px;border-radius:5px;margin-top:10px;">
              <h3>ğŸ¯ æœ¬æ¬¡æ„å»ºåŒ…å«:</h3>
              <ul>
              <li>Windows x64/x86 ç‰ˆæœ¬</li>
              <li>Linux x64/x86 ç‰ˆæœ¬</li>
              <li>macOS Intel/ARM ç‰ˆæœ¬</li>
              <li>æ‰€æœ‰ç‰ˆæœ¬å‡åŒ…å«SHA256æ ¡éªŒæ–‡ä»¶</li>
              </ul>
              </div>
              "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          } else {
              @"
              <h1>ğŸš€ Releaseå·²å‘å¸ƒï¼</h1>
              <p>æ­£å¼Releaseï¼š<a href='$releaseUrl'>ç‚¹æ­¤æŸ¥çœ‹</a></p>
              <div style="background:#e8f5e9;padding:15px;border-radius:5px;margin-top:10px;">
              <h3>âœ… æ„å»ºå®Œæˆ:</h3>
              <ul>
              <li>ç‰ˆæœ¬: ${{ github.event.inputs.version }}</li>
              <li>æ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm')</li>
              <li>åŒ…å«: 6ä¸ªå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶</li>
              </ul>
              </div>
              "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          }
          
          Write-Host "âœ… Releaseé¡µé¢å·²æ›´æ–°åˆ°æ‘˜è¦" -ForegroundColor Green