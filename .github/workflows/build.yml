name: Build and Create Release Draft

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        type: string

jobs:
  check:
    name: Check code error
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyflakes

      - name: Check
        id: check
        run: |
          pyflakes . > errors.txt || :
          if [ -s errors.txt ]; then
            echo "æœ‰é”™è¯¯"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "æ— é”™è¯¯"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: errors
          path: errors.txt

  echo-error:
    needs: check
    name: Echo errors
    runs-on: ubuntu-latest
    if: ${{ needs.check.outputs.should_build }} == "false"
    steps:
      - name: Download errors
        uses: actions/download-artifact@v4
        with:
          name: errors

      - name: Echo errors and add to Summary
        run: |
          errors=$(<errors.txt)
          echo $errors
          echo "<h1>Check error!</h1>Find errors!Please edit.<br>ERRORS:<br>$errors" >> $GITHUB_STEP_SUMMARY

  build:
    needs: check
    name: Build Executables
    runs-on: ${{ matrix.os }}
    if: ${{ needs.check.outputs.should_build }} == "true"
    strategy:
      matrix:
        include:
          - name: 'winx64'
            os: 'windows-latest'
            arch: 'x64'
          - name: 'winx86'
            os: 'windows-latest'
            arch: 'x86'
          - name: 'linuxx64'
            os: 'ubuntu-latest'
            arch: 'x64'
          - name: 'linuxx86'
            os: 'ubuntu-latest'
            arch: 'x86'
          - name: 'macosintel'
            os: 'macos-latest'
            arch: 'x64'
          - name: 'macosm'
            os: 'macos-latest'
            arch: 'arm64'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
  
      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
  
      - name: Build executable for Windows
        if: matrix.os == 'windows-latest'
        run: |
          echo "=== å¼€å§‹æ„å»º ${{ matrix.name }} ==="
          pyinstaller --noconfirm --onefile --windowed --name "${{ matrix.name }}.exe" main.py
          echo "=== æ„å»ºå®Œæˆ ==="
  
      - name: Build executable for Unix
        if: matrix.os != 'windows-latest'
        run: |
          echo "=== å¼€å§‹æ„å»º ${{ matrix.name }} ==="
          pyinstaller --noconfirm --onefile --name "${{ matrix.name }}" main.py
          echo "=== æ„å»ºå®Œæˆ ==="
  
      - name: Generate SHA256 checksum for Windows
        if: matrix.os == 'windows-latest'
        run: |
          echo "=== ç”Ÿæˆ ${{ matrix.name }} çš„ SHA256 æ ¡éªŒç  ==="
          certutil -hashfile "dist/${{ matrix.name }}.exe" SHA256 | findstr /v "CertUtil" | findstr /v ":" > "checksum_temp.txt"
          set /p CHECKSUM=<checksum_temp.txt
          echo "${{ matrix.name }}:%CHECKSUM%" > sha256_${{ matrix.name }}.txt
          del checksum_temp.txt
          echo "===ç”Ÿæˆå®Œæˆ==="
        shell: cmd
  
      - name: Generate SHA256 checksum for Unix
        if: matrix.os != 'windows-latest'
        run: |
          echo "=== ç”Ÿæˆ ${{ matrix.name }} çš„ SHA256 æ ¡éªŒç  ==="
          shasum -a 256 "dist/${{ matrix.name }}" | cut -d ' ' -f 1 > "checksum_temp.txt"
          CHECKSUM=$(cat "checksum_temp.txt")
          echo "${{ matrix.name }}:$CHECKSUM" > sha256_${{ matrix.name }}.txt
          rm -f "checksum_temp.txt"
          echo "===ç”Ÿæˆå®Œæˆ==="
  
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: |
            dist/${{ matrix.name }}*
            sha256_${{ matrix.name }}.txt

  create-release:
    name: Create Release Draft
    needs: [check, build]
    runs-on: ubuntu-latest
    if: ${{ needs.check.outputs.should_build }} == "true"
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
  
      - name: Create Release Draft with Tag
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          draft: true
          files: |
            ./artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
      - name: Add Release Link to Summary
        run: echo "<h1>ğŸš€ è‰ç¨¿Releaseå·²åˆ›å»º</h1>è‰ç¨¿Releaseï¼š<a href='${{ steps.create-release.outputs.url }}'>ç‚¹æ­¤è·³è½¬</a><br>ä»“åº“åä½œè€…å¯è¿›è¡Œå®Œå–„ç„¶åå‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
